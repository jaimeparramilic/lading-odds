"use strict";(()=>{var e={};e.id=316,e.ids=[316],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},2254:e=>{e.exports=require("node:buffer")},6005:e=>{e.exports=require("node:crypto")},7261:e=>{e.exports=require("node:util")},4911:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>E,requestAsyncStorage:()=>O,routeModule:()=>x,serverHooks:()=>A,staticGenerationAsyncStorage:()=>$});var o={};r.r(o),r.d(o,{GET:()=>R,runtime:()=>l});var n=r(9303),a=r(8716),s=r(670),i=r(7070),p=r(6113),c=r.n(p),u=r(1814);let l="nodejs",{SHOPIFY_API_KEY:d,SHOPIFY_API_SECRET:h,SHOPIFY_SCOPES:m,SHOPIFY_API_VERSION:f,APP_URL:_}=process.env,g=(_||"").replace(/\/+$/,""),P=(h||"").replace(/\r?\n/g,"").trim(),S=new Set(["hmac","signature","debug","check","dryrun","format"]);function y(e,t){return i.NextResponse.json(t,{status:e,headers:{"Cache-Control":"no-store"}})}function C(e){return!!e&&/^[a-z0-9][a-z0-9-]*\.myshopify\.com$/i.test(e)}function I(e,t){for(let r of t.headers.getSetCookie?.()??t.headers.get("set-cookie")?.split(/,(?=\s*\w+=)/g)??[])r&&"string"==typeof r&&e.headers.append("Set-Cookie",r)}async function R(e){if(!d||!P||!m||!g)return y(500,{error:"Faltan variables de entorno",SHOPIFY_API_KEY:!!d,SHOPIFY_API_SECRET:!!P,SHOPIFY_SCOPES:!!m,APP_URL:g});let t=new URL(e.url),r=t.searchParams.get("shop")||e.cookies.get("shopify_shop")?.value||"",o=t.searchParams.get("code"),n=t.searchParams.get("check"),a=t.searchParams.get("dryrun"),s=t.searchParams.get("debug"),p=t.searchParams.get("format"),l=`${g}/api/shopify/oauth`;if(!o&&"1"===n){let t=C(r)?r:"",o=t?`https://${t}/admin/oauth/authorize?client_id=${encodeURIComponent(d)}&scope=${encodeURIComponent(m)}&redirect_uri=${encodeURIComponent(l)}&state=<RANDOM_STATE>`:"(agrega ?shop=tu-tienda.myshopify.com)";return y(200,{note:"Diagn\xf3stico: esto es lo que enviar\xedamos a Shopify (no se redirige)",app_url_env:g,request_origin_deduced:`https://${e.headers.get("host")}`,redirect_uri_expected:l,redirect_uri_must_match_allowed:l,shop_input:r,shop_validated:t,example_authorize_url:o,tips:["Allowed redirection URL debe coincidir EXACTO con redirect_uri","SHOPIFY_API_SECRET = Client secret del app"]})}if(!o){if(!C(r))return y(400,{error:"Par\xe1metro 'shop' inv\xe1lido. Ej: tu-tienda.myshopify.com",shop:r});if("1"===a){let e=c().randomBytes(24).toString("base64url"),t=`https://${r}/admin/oauth/authorize?client_id=${encodeURIComponent(d)}&scope=${encodeURIComponent(m)}&redirect_uri=${encodeURIComponent(l)}&state=${encodeURIComponent(e)}`;return new i.NextResponse(t,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8","Cache-Control":"no-store"}})}let e=c().randomBytes(24).toString("base64url"),t=`https://${r}/admin/oauth/authorize?client_id=${encodeURIComponent(d)}&scope=${encodeURIComponent(m)}&redirect_uri=${encodeURIComponent(l)}&state=${encodeURIComponent(e)}`,o=i.NextResponse.redirect(t);return o.cookies.set("shopify_oauth_state",e,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),o.cookies.set("shopify_shop",r,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),o}if("2"===s){let o=t.searchParams.get("hmac")||"",n=function(e){let t=Array.from(new Set(Array.from(e.searchParams.keys()))).filter(e=>!S.has(e)).sort((e,t)=>e.localeCompare(t)),r=[];for(let o of t)for(let t of e.searchParams.getAll(o).sort((e,t)=>e.localeCompare(t)))r.push(`${o}=${t}`);return r.join("&")}(t),a=c().createHmac("sha256",P).update(n,"utf8").digest("hex");return y(200,{note:"DEBUG2: inspecci\xf3n del callback (no se canjea el token)",full_url:e.url,shop:r,hmac:{given:o,expected:a,message_signed:n,match:function(e,t){let r=Buffer.from((e||"").toLowerCase(),"hex"),o=Buffer.from((t||"").toLowerCase(),"hex");return r.length===o.length&&c().timingSafeEqual(r,o)}(a,o)},redirect_uri_expected:l})}try{let t=new Response(null,{headers:new Headers}),{session:r,shop:o}=await u.hG.auth.callback({isOnline:!1,request:e,response:t}),n=r.accessToken,a=r.scope||"",s=f||"2025-07";if("json"===p){let e=y(200,{ok:!0,shop:o,api_version:s,access_token:n,scope:a,saved_at:new Date().toISOString()});return I(e,t),e}let c=`${n.slice(0,6)}…${n.slice(-4)}`,l=JSON.stringify({access_token:n,scope:a,shop:o,api_version:s,saved_at:new Date().toISOString()},null,2),d=new i.NextResponse(`<!doctype html><html><body style="font-family:system-ui;padding:28px">
        <h1>✅ OAuth OK</h1>
        <p><b>Tienda:</b> ${o}</p>
        <p><b>Versi\xf3n API:</b> ${s}</p>
        <p><b>Scope:</b> ${a}</p>
        <p><b>Access token:</b> <span style="color:#0a7f3f">${c}</span></p>
        <p><a href="data:application/json;charset=utf-8,${encodeURIComponent(l)}" download="${o.replace(/\./g,"_")}.json">Descargar JSON</a></p>
        <p>Para pipelines, vuelve con <code>&format=json</code>.</p>
      </body></html>`,{headers:{"Content-Type":"text/html; charset=utf-8","Cache-Control":"no-store"}});return I(d,t),d}catch(e){return y(400,{error:"OAuth callback fall\xf3",details:String(e)})}}let x=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/shopify/oauth/route",pathname:"/api/shopify/oauth",filename:"route",bundlePath:"app/api/shopify/oauth/route"},resolvedPagePath:"/Users/admin/Documents/ODDS/landing/lading-odds/app/api/shopify/oauth/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:O,staticGenerationAsyncStorage:$,serverHooks:A}=x,v="/api/shopify/oauth/route";function E(){return(0,s.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:$})}},1814:(e,t,r)=>{r.d(t,{a8:()=>c,hG:()=>p}),r(1602);var o=r(3116);let n=(process.env.APP_URL||"").replace(/\/+$/,""),a=process.env.SHOPIFY_API_KEY||"",s=(process.env.SHOPIFY_API_SECRET||"").replace(/\r?\n/g,"").trim(),i=(process.env.SHOPIFY_SCOPES||"").split(",").map(e=>e.trim()).filter(Boolean);if(!n||!a||!s||0===i.length)throw Error("Faltan envs: APP_URL / SHOPIFY_API_KEY / SHOPIFY_API_SECRET / SHOPIFY_SCOPES");let p=(0,o.OP)({apiKey:a,apiSecretKey:s,scopes:i,apiVersion:o.wr,hostName:new URL(n).host,hostScheme:new URL(n).protocol.replace(":",""),isEmbeddedApp:!1});function c(e,t){return new p.clients.Rest({session:{id:`${e}_offline`,shop:e,state:"unused",isOnline:!1,scope:"",accessToken:t,expires:void 0}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,972,129],()=>r(4911));module.exports=o})();