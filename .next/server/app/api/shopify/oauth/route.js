"use strict";(()=>{var e={};e.id=316,e.ids=[316],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9295:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>A,patchFetch:()=>k,requestAsyncStorage:()=>S,routeModule:()=>x,serverHooks:()=>R,staticGenerationAsyncStorage:()=>P});var o={};a.r(o),a.d(o,{GET:()=>v,runtime:()=>u});var s=a(9303),r=a(8716),n=a(670),i=a(7070);let p=require("crypto");var c=a.n(p);let u="nodejs",{SHOPIFY_API_KEY:h,SHOPIFY_API_SECRET:d,SHOPIFY_SCOPES:l,SHOPIFY_API_VERSION:m,APP_URL:f}=process.env,g=(f||"").replace(/\/+$/,"");function _(e,t){try{return c().timingSafeEqual(Buffer.from(e,"utf8"),Buffer.from(t,"utf8"))}catch{return!1}}function y(e,t){let a=e.searchParams.get("hmac")||"",o=Array.from(e.searchParams.keys()).filter(e=>"hmac"!==e&&"signature"!==e).sort((e,t)=>e<t?-1:e>t?1:0),s=[];for(let t of o)for(let a of e.searchParams.getAll(t))s.push(`${t}=${a}`);let r=s.join("&"),n=c().createHmac("sha256",t).update(r,"utf8").digest("hex"),i=_(n,a),p=e.toString(),u=p.includes("?")?p.split("?",2)[1]:"",h=u?u.split("&").filter(Boolean):[],d=[];for(let e of h){let t=e.indexOf("="),a=t>=0?e.slice(0,t):e,o=t>=0?e.slice(t+1):"";"hmac"!==a&&"signature"!==a&&d.push({k:a,v:o})}d.sort((e,t)=>e.k<t.k?-1:e.k>t.k?1:0);let l=d.map(({k:e,v:t})=>`${e}=${t}`),m=l.join("&"),f=c().createHmac("sha256",t).update(m,"utf8").digest("hex"),g=_(f,a);return{ok:i||g,given_hmac:a,variant:i?"A":g?"B":"none",decoded:{keys:o,pairs:s,message:r,digest:n,same:i},raw:{raw_query:u,pairs:l,message:m,digest:f,same:g}}}async function v(e){if(!h||!d||!l||!g)return i.NextResponse.json({error:"Faltan variables de entorno",SHOPIFY_API_KEY:!!h,SHOPIFY_API_SECRET:!!d,SHOPIFY_SCOPES:!!l,APP_URL:g},{status:500});let t=e.url,a=new URL(t),o=a.searchParams.get("shop")||e.cookies.get("shopify_shop")?.value||"",s=a.searchParams.get("code"),r=a.searchParams.get("state"),n=a.searchParams.get("format"),p=a.searchParams.get("check"),u=a.searchParams.get("dryrun"),f="1"===a.searchParams.get("debug"),_="2"===a.searchParams.get("debug"),v=`${g}/api/shopify/oauth`;if(console.log("[Shopify OAuth] Incoming URL:",t),!s&&"1"===p){let e=o&&o.endsWith(".myshopify.com")?`https://${o}/admin/oauth/authorize?client_id=${encodeURIComponent(h)}&scope=${encodeURIComponent(l)}&redirect_uri=${encodeURIComponent(v)}&state=<RANDOM_STATE>`:"(agrega ?shop=tu-tienda.myshopify.com)";return i.NextResponse.json({note:"Diagn\xf3stico: esto es lo que enviar\xedamos a Shopify (no se redirige)",shop:o,app_url_env:g,redirect_uri:v,must_match_allowed_redirect:`${g}/api/shopify/oauth`,example_authorize_url:e})}if(!s){if(!o.endsWith(".myshopify.com"))return i.NextResponse.json({error:"Par\xe1metro 'shop' inv\xe1lido. Ej: tu-tienda.myshopify.com",shop:o},{status:400});let e=c().randomBytes(24).toString("base64url"),t=`https://${o}/admin/oauth/authorize?client_id=${encodeURIComponent(h)}&scope=${encodeURIComponent(l)}&redirect_uri=${encodeURIComponent(v)}&state=${encodeURIComponent(e)}`;if(console.log("[Shopify OAuth] redirectUri:",v),console.log("[Shopify OAuth] authorizeUrl:",t),"1"===u)return new i.NextResponse(t,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}});let a=i.NextResponse.redirect(t);return a.cookies.set("shopify_oauth_state",e,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),a.cookies.set("shopify_shop",o,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),a}if(!o.endsWith(".myshopify.com"))return i.NextResponse.json({error:"Shop inv\xe1lido",shop:o},{status:400});let x=e.cookies.get("shopify_oauth_state")?.value||"",S=e.cookies.get("shopify_shop")?.value||"";if(_){let s=y(a,d);return i.NextResponse.json({note:"DEBUG2: inspecci\xf3n completa del callback",full_url:t,headers:{host:e.headers.get("host"),user_agent:e.headers.get("user-agent"),sec_fetch_site:e.headers.get("sec-fetch-site")},shop:o,state_param:r,cookies:{stateCookie:x,shopCookie:S},hmac:{given:s.given_hmac,matched_variant:s.variant,variant_A:s.decoded,variant_B:s.raw},redirect_uri_expected:v})}if(!r||r!==x||!S||S!==o)return i.NextResponse.json({error:"STATE/SHOP inv\xe1lidos",state:r,stateCookie:x,shopCookie:S,shop:o},{status:400});if(f){let e=y(a,d);return i.NextResponse.json({note:"DEBUG1 HMAC",shop:o,given_hmac:e.given_hmac,matched_variant:e.variant,variant_A:e.decoded,variant_B:e.raw})}if(!y(a,d).ok)return i.NextResponse.json({error:"HMAC inv\xe1lido"},{status:400});let P=await fetch(`https://${o}/admin/oauth/access_token`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({client_id:h,client_secret:d,code:s}),cache:"no-store"});if(!P.ok){let e=await P.text();return i.NextResponse.json({error:"Intercambio de token fall\xf3",details:e},{status:400})}let R=await P.json(),A=R.access_token,k=R.scope||"",$=m||"2025-07";if("json"===n)return i.NextResponse.json({ok:!0,shop:o,api_version:$,access_token:A,scope:k,saved_at:new Date().toISOString()});let j=`${A.slice(0,6)}…${A.slice(-4)}`,O=JSON.stringify({access_token:A,scope:k,shop:o,api_version:$,saved_at:new Date().toISOString()},null,2);return new i.NextResponse(`<!doctype html><html><body style="font-family:system-ui;padding:28px">
      <h1>✅ OAuth OK</h1>
      <p><b>Tienda:</b> ${o}</p>
      <p><b>Versi\xf3n API:</b> ${$}</p>
      <p><b>Scope:</b> ${k}</p>
      <p><b>Access token:</b> <span style="color:#0a7f3f">${j}</span></p>
      <p><a href="data:application/json;charset=utf-8,${encodeURIComponent(O)}" download="${o.replace(/\./g,"_")}.json">Descargar JSON</a></p>
      <p>Para pipelines, vuelve con <code>&format=json</code>.</p>
    </body></html>`,{headers:{"Content-Type":"text/html; charset=utf-8"}})}let x=new s.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/shopify/oauth/route",pathname:"/api/shopify/oauth",filename:"route",bundlePath:"app/api/shopify/oauth/route"},resolvedPagePath:"/Users/admin/Documents/ODDS/landing/lading-odds/app/api/shopify/oauth/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:S,staticGenerationAsyncStorage:P,serverHooks:R}=x,A="/api/shopify/oauth/route";function k(){return(0,n.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:P})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[948,972],()=>a(9295));module.exports=o})();