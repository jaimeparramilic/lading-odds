"use strict";(()=>{var e={};e.id=316,e.ids=[316],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9295:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>S,patchFetch:()=>R,requestAsyncStorage:()=>x,routeModule:()=>_,serverHooks:()=>P,staticGenerationAsyncStorage:()=>v});var s={};o.r(s),o.d(s,{GET:()=>g,runtime:()=>u});var a=o(9303),r=o(8716),n=o(670),i=o(7070);let p=require("crypto");var c=o.n(p);let u="nodejs",{SHOPIFY_API_KEY:h,SHOPIFY_API_SECRET:l,SHOPIFY_SCOPES:d,SHOPIFY_API_VERSION:m,APP_URL:f}=process.env,y=(f||"").replace(/\/+$/,"");async function g(e){if(!h||!l||!d||!y)return i.NextResponse.json({error:"Faltan variables de entorno",SHOPIFY_API_KEY:!!h,SHOPIFY_API_SECRET:!!l,SHOPIFY_SCOPES:!!d,APP_URL:y},{status:500});let t=new URL(e.url),o=t.searchParams.get("shop")||e.cookies.get("shopify_shop")?.value||"",s=t.searchParams.get("code"),a=t.searchParams.get("state"),r=t.searchParams.get("format"),n=t.searchParams.get("check"),p=t.searchParams.get("dryrun"),u="1"===t.searchParams.get("debug"),f=`${y}/api/shopify/oauth`;if(!s&&"1"===n){let e=o&&o.endsWith(".myshopify.com")?`https://${o}/admin/oauth/authorize?client_id=${encodeURIComponent(h)}&scope=${encodeURIComponent(d)}&redirect_uri=${encodeURIComponent(f)}&state=<RANDOM_STATE>`:"(agrega ?shop=tu-tienda.myshopify.com)";return i.NextResponse.json({note:"Diagn\xf3stico: esto es lo que enviar\xedamos a Shopify (no se redirige)",shop:o,app_url_env:y,redirect_uri:f,must_match_allowed_redirect:`${y}/api/shopify/oauth`,example_authorize_url:e})}if(!s){if(!o.endsWith(".myshopify.com"))return i.NextResponse.json({error:"Par\xe1metro 'shop' inv\xe1lido. Ej: tu-tienda.myshopify.com",shop:o},{status:400});let e=c().randomBytes(24).toString("base64url"),t=`https://${o}/admin/oauth/authorize?client_id=${encodeURIComponent(h)}&scope=${encodeURIComponent(d)}&redirect_uri=${encodeURIComponent(f)}&state=${encodeURIComponent(e)}`;if(console.log("[Shopify OAuth] redirectUri:",f),console.log("[Shopify OAuth] authorizeUrl:",t),"1"===p)return new i.NextResponse(t,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}});let s=i.NextResponse.redirect(t);return s.cookies.set("shopify_oauth_state",e,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),s.cookies.set("shopify_shop",o,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),s}if(!o.endsWith(".myshopify.com"))return i.NextResponse.json({error:"Shop inv\xe1lido",shop:o},{status:400});let g=e.cookies.get("shopify_oauth_state")?.value,_=e.cookies.get("shopify_shop")?.value;if(!a||a!==g||!_||_!==o)return i.NextResponse.json({error:"STATE/SHOP inv\xe1lidos",state:a,stateCookie:g,shopCookie:_,shop:o},{status:400});let{same:x,message:v,given:P,digest:S}=function(e,t){let o=e.searchParams.get("hmac")||"",s=Array.from(e.searchParams.keys()).filter(e=>"hmac"!==e&&"signature"!==e).sort((e,t)=>e<t?-1:e>t?1:0),a=[];for(let t of s)for(let o of e.searchParams.getAll(t))a.push(`${t}=${o}`);let r=a.join("&"),n=c().createHmac("sha256",t).update(r,"utf8").digest("hex"),i=!1;try{i=c().timingSafeEqual(Buffer.from(n,"utf8"),Buffer.from(o,"utf8"))}catch{i=!1}return{same:i,message:r,given:o,digest:n}}(t,l);if(u)return i.NextResponse.json({note:"DEBUG HMAC (no dejes esto activado en prod p\xfablica)",shop:o,message:v,given_hmac:P,calculated_hmac:S,same:x});if(!x)return i.NextResponse.json({error:"HMAC inv\xe1lido"},{status:400});let R=await fetch(`https://${o}/admin/oauth/access_token`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({client_id:h,client_secret:l,code:s}),cache:"no-store"});if(!R.ok){let e=await R.text();return i.NextResponse.json({error:"Intercambio de token fall\xf3",details:e},{status:400})}let j=await R.json(),$=j.access_token,A=j.scope||"",O=m||"2025-07";if("json"===r)return i.NextResponse.json({ok:!0,shop:o,api_version:O,access_token:$,scope:A,saved_at:new Date().toISOString()});let b=`${$.slice(0,6)}…${$.slice(-4)}`,C=JSON.stringify({access_token:$,scope:A,shop:o,api_version:O,saved_at:new Date().toISOString()},null,2);return new i.NextResponse(`<!doctype html><html><body style="font-family:system-ui;padding:28px">
      <h1>✅ OAuth OK</h1>
      <p><b>Tienda:</b> ${o}</p>
      <p><b>Versi\xf3n API:</b> ${O}</p>
      <p><b>Scope:</b> ${A}</p>
      <p><b>Access token:</b> <span style="color:#0a7f3f">${b}</span></p>
      <p><a href="data:application/json;charset=utf-8,${encodeURIComponent(C)}" download="${o.replace(/\./g,"_")}.json">Descargar JSON</a></p>
      <p>Para pipelines, vuelve con <code>&format=json</code>.</p>
    </body></html>`,{headers:{"Content-Type":"text/html; charset=utf-8"}})}let _=new a.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/shopify/oauth/route",pathname:"/api/shopify/oauth",filename:"route",bundlePath:"app/api/shopify/oauth/route"},resolvedPagePath:"/Users/admin/Documents/ODDS/landing/lading-odds/app/api/shopify/oauth/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:v,serverHooks:P}=_,S="/api/shopify/oauth/route";function R(){return(0,n.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:v})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[948,972],()=>o(9295));module.exports=s})();