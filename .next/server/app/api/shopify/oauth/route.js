"use strict";(()=>{var e={};e.id=316,e.ids=[316],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9295:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>C,patchFetch:()=>b,requestAsyncStorage:()=>k,routeModule:()=>A,serverHooks:()=>I,staticGenerationAsyncStorage:()=>O});var r={};o.r(r),o.d(r,{GET:()=>x,runtime:()=>h});var a=o(9303),s=o(8716),i=o(670),n=o(7070);let c=require("crypto");var p=o.n(c);let h="nodejs",{SHOPIFY_API_KEY:l,SHOPIFY_API_SECRET:u,SHOPIFY_SCOPES:d,SHOPIFY_API_VERSION:m,APP_URL:f,MAX_TIMESTAMP_SKEW_SEC:g="600"}=process.env,_=(f||"").replace(/\/+$/,""),y=/^[a-z0-9][a-z0-9-]*\.myshopify\.com$/i;function S(e,t){return new n.NextResponse(JSON.stringify(t),{status:e,headers:{"content-type":"application/json; charset=utf-8","cache-control":"no-store"}})}let P=new Set(["hmac","signature","debug","format","check","dryrun"]);function v(e,t){let o=(e.searchParams.get("hmac")||"").toLowerCase(),r=function(e){let t=Array.from(new Set(Array.from(e.searchParams.keys()))),o=[];for(let r of t)if(!P.has(r))for(let t of e.searchParams.getAll(r))o.push([r,t]);return o.sort((e,t)=>e[0]===t[0]?e[1].localeCompare(t[1]):e[0].localeCompare(t[0])),o.map(([e,t])=>`${e}=${t}`).join("&")}(e),a=p().createHmac("sha256",t).update(r,"utf8").digest("hex");return{ok:function(e,t){if(!e||!t)return!1;let o=Buffer.from(e.toLowerCase(),"hex"),r=Buffer.from(t.toLowerCase(),"hex");return o.length===r.length&&p().timingSafeEqual(o,r)}(a,o),given_hmac:o,message:r,digest:a}}async function x(e){if(!l||!u||!d||!_)return S(500,{error:"Faltan variables de entorno",SHOPIFY_API_KEY:!!l,SHOPIFY_API_SECRET:!!u,SHOPIFY_SCOPES:!!d,APP_URL:_,tip:"Configura SHOPIFY_API_KEY, SHOPIFY_API_SECRET, SHOPIFY_SCOPES y APP_URL (sin slash final)."});let t=e.url,o=new URL(t),r=function(e){let t=(e.headers.get("x-forwarded-proto")||"https").split(",")[0].trim(),o=(e.headers.get("x-forwarded-host")||e.headers.get("host")||"").split(",")[0].trim();if(o)return`${t}://${o}`}(e),a=`${_}/api/shopify/oauth`,s=o.searchParams.get("shop")||e.cookies.get("shopify_shop")?.value||"",i=o.searchParams.get("code"),c=o.searchParams.get("state"),h=o.searchParams.get("timestamp")||"",f=o.searchParams.get("format"),P=o.searchParams.get("check"),x=o.searchParams.get("dryrun"),A=o.searchParams.get("debug");console.log("[Shopify OAuth] Incoming URL:",t),console.log("[Shopify OAuth] Host:",e.headers.get("host"),"→ originFromReq:",r),console.log("[Shopify OAuth] redirectUri:",a);let k=s&&y.test(s)?s:"";if(!i&&"1"===P){let e=k?`https://${k}/admin/oauth/authorize?client_id=${encodeURIComponent(l)}&scope=${encodeURIComponent(d)}&redirect_uri=${encodeURIComponent(a)}&state=<RANDOM_STATE>`:"(agrega ?shop=tu-tienda.myshopify.com)";return S(200,{note:"Diagn\xf3stico: esto es lo que enviar\xedamos a Shopify (no se redirige)",app_url_env:_,request_origin_deduced:r,redirect_uri_expected:a,redirect_uri_must_match_allowed:`${_}/api/shopify/oauth`,shop_input:s,shop_validated:k,example_authorize_url:e,tips:["Verifica que el Allowed redirection URL coincide EXACTO con redirect_uri.","SHOPIFY_API_SECRET debe ser el Client secret del app."]})}if(!i){if(!k)return S(400,{error:"Par\xe1metro 'shop' inv\xe1lido. Ej: tu-tienda.myshopify.com",shop:s});let e=p().randomBytes(24).toString("base64url"),t=`https://${k}/admin/oauth/authorize?client_id=${encodeURIComponent(l)}&scope=${encodeURIComponent(d)}&redirect_uri=${encodeURIComponent(a)}&state=${encodeURIComponent(e)}`;if(console.log("[Shopify OAuth] authorizeUrl:",t),"1"===x)return new n.NextResponse(t,{status:200,headers:{"content-type":"text/plain; charset=utf-8","cache-control":"no-store"}});let o=n.NextResponse.redirect(t);return o.cookies.set("shopify_oauth_state",e,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),o.cookies.set("shopify_shop",k,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:300}),o}if(!k)return S(400,{error:"Shop inv\xe1lido",shop:s});if("2"===A){let s=v(o,u);return S(200,{note:"DEBUG2: inspecci\xf3n completa del callback (no se canjea el token)",full_url:t,headers:{host:e.headers.get("host"),user_agent:e.headers.get("user-agent"),sec_fetch_site:e.headers.get("sec-fetch-site")},shop:k,state_param:c,cookies_seen:{stateCookie:e.cookies.get("shopify_oauth_state")?.value||"",shopCookie:e.cookies.get("shopify_shop")?.value||""},hmac:{given:s.given_hmac,expected:s.digest,message_signed:s.message,match:s.ok},redirect_uri_expected:a,request_origin_deduced:r,timestamp_param:h})}if("1"===A){let e=v(o,u);return S(200,{note:"DEBUG1 HMAC (sin validar state)",shop:k,given_hmac:e.given_hmac,expected_digest:e.digest,message:e.message,ok:e.ok,hint:"Si no coincide, revisa SHOPIFY_API_SECRET y el redirect_uri exacto en el dashboard."})}if(!v(o,u).ok)return S(400,{error:"HMAC inv\xe1lido",hint:"Agrega ?debug=1 para ver el mensaje can\xf3nico y el digest esperado."});let O=e.cookies.get("shopify_oauth_state")?.value||"",I=e.cookies.get("shopify_shop")?.value||"";if(!c||c!==O||!I||I!==k)return S(400,{error:"STATE/SHOP inv\xe1lidos",details:{state:c,stateCookie:O,shop:k,shopCookie:I},hint:"Aseg\xfarate de que el callback llega al MISMO dominio que inici\xf3 el flujo (cookies)."});if(h){let e=Math.floor(Date.now()/1e3),t=Number.parseInt(h,10),o=Number.parseInt(String(g),10)||600;if(Number.isFinite(t)&&Math.abs(e-t)>o)return S(400,{error:"Timestamp fuera de ventana",details:{nowSec:e,timestamp:t,maxSkewSec:o}})}let C=await fetch(`https://${k}/admin/oauth/access_token`,{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify({client_id:l,client_secret:u,code:i}),cache:"no-store"});if(!C.ok)return S(400,{error:"Intercambio de token fall\xf3",details:await C.text()});let b=await C.json(),R=b.access_token,$=b.scope||"",w=m||"2025-07";if("json"===f)return S(200,{ok:!0,shop:k,api_version:w,access_token:R,scope:$,saved_at:new Date().toISOString()});let E=`${R.slice(0,6)}…${R.slice(-4)}`,U=JSON.stringify({access_token:R,scope:$,shop:k,api_version:w,saved_at:new Date().toISOString()},null,2);return function(e,t=200){return new n.NextResponse(e,{status:t,headers:{"content-type":"text/html; charset=utf-8","cache-control":"no-store"}})}(`<!doctype html><html><body style="font-family:system-ui;padding:28px">
      <h1>✅ OAuth OK</h1>
      <p><b>Tienda:</b> ${k}</p>
      <p><b>Versi\xf3n API:</b> ${w}</p>
      <p><b>Scope:</b> ${$}</p>
      <p><b>Access token:</b> <span style="color:#0a7f3f">${E}</span></p>
      <p><a href="data:application/json;charset=utf-8,${encodeURIComponent(U)}" download="${k.replace(/\./g,"_")}.json">Descargar JSON</a></p>
      <p>Para pipelines, vuelve con <code>&format=json</code>.</p>
    </body></html>`)}let A=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/shopify/oauth/route",pathname:"/api/shopify/oauth",filename:"route",bundlePath:"app/api/shopify/oauth/route"},resolvedPagePath:"/Users/admin/Documents/ODDS/landing/lading-odds/app/api/shopify/oauth/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:k,staticGenerationAsyncStorage:O,serverHooks:I}=A,C="/api/shopify/oauth/route";function b(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:O})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[948,972],()=>o(9295));module.exports=r})();